<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>즐겨찾기 병원 - 베베 접종 수첩</title>
    <link rel="stylesheet" href="/css/headerMenu/bookmark.css" />
	<link rel="stylesheet" href="/css/login/insertModal.css" />
	<link rel="stylesheet" href="/css/fragments/layout.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
	<!-- header -->
		<div th:replace="~{fragments/header::header}"></div>
		
	    <!-- 회원가입 모달 -->
	    <div th:replace="~{fragments/insertModal::insertModal}"></div>
		
	<!--	로그인 모달-->
		<div th:replace="~{fragments/loginModal::loginModal}"></div>    

	
    <div class="bookmark-container">
        <!-- 왼쪽: 즐겨찾기 병원 목록 -->
        <div class="bookmark-section">
            <div class="section-title">
                <i class="fa-solid fa-star"></i>
                즐겨찾기
            </div>
            
            <div class="hospital-list" id="hospitalList">
                <!-- 예시 데이터 -->
                <div class="hospital-item active" onclick="selectHospital(this, 0)">
                    <div class="hospital-header">
                        <div class="hospital-name">지은소아과</div>
                        <button class="bookmark-btn" onclick="toggleBookmark(event, 0)">
                            <i class="fa-solid fa-star"></i>
                        </button>
                    </div>
                    <div class="hospital-info">
                        <div><i class="fa-solid fa-location-dot"></i> 부산광역시 동래구 중앙대로 123</div>
                        <div><i class="fa-solid fa-phone"></i> 051-1234-5678</div>
                    </div>
                </div>

                <div class="hospital-item" onclick="selectHospital(this, 1)">
                    <div class="hospital-header">
                        <div class="hospital-name">현신소아과</div>
                        <button class="bookmark-btn" onclick="toggleBookmark(event, 1)">
                            <i class="fa-solid fa-star"></i>
                        </button>
                    </div>
                    <div class="hospital-info">
                        <div><i class="fa-solid fa-location-dot"></i> 부산광역시 동래구 명륜로 456</div>
                        <div><i class="fa-solid fa-phone"></i> 051-2345-6789</div>
                    </div>
                </div>

                <div class="hospital-item" onclick="selectHospital(this, 2)">
                    <div class="hospital-header">
                        <div class="hospital-name">동래이동병원</div>
                        <button class="bookmark-btn" onclick="toggleBookmark(event, 2)">
                            <i class="fa-solid fa-star"></i>
                        </button>
                    </div>
                    <div class="hospital-info">
                        <div><i class="fa-solid fa-location-dot"></i> 부산광역시 동래구 충렬대로 789</div>
                        <div><i class="fa-solid fa-phone"></i> 051-3456-7890</div>
                    </div>
                </div>

                <!-- 즐겨찾기가 없을 때 표시 -->
                <!-- <div class="empty-message" style="display: none;">
                    <i class="fa-regular fa-star"></i>
                    <div>즐겨찾기한 병원이 없습니다</div>
                </div> -->
            </div>
        </div>

        <!-- 오른쪽: 검색 및 상세 정보 -->
        <div class="info-section">
            <!-- 검색 -->
            <div class="search-card">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="병원 이름 또는 주소를 검색하세요">
                    <button class="search-btn" onclick="searchHospital(document.getElementById('searchInput').value || '소아과')">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        검색
                    </button>
                </div>
            </div>

            <!-- 병원 상세 정보 -->
            <div class="hospital-detail-card">
                <div class="detail-header">
                    <div class="detail-title">병원 정보</div>
                    <i class="fa-solid fa-star bookmark-star"></i>
                </div>

                <div class="detail-content" id="detailContent">
                    <div class="info-row">
                        <div class="info-label">
                            <i class="fa-solid fa-hospital"></i>
                            병원명
                        </div>
                        <div class="info-value">지은소아과</div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">
                            <i class="fa-solid fa-location-dot"></i>
                            주소
                        </div>
                        <div class="info-value">부산광역시 동래구 중앙대로 123</div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">
                            <i class="fa-solid fa-phone"></i>
                            전화번호
                        </div>
                        <div class="info-value">051-1234-5678</div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">
                            <i class="fa-solid fa-clock"></i>
                            진료시간
                        </div>
                        <div class="info-value">
                            평일 09:00 - 18:00<br>
                            토요일 09:00 - 13:00<br>
                            일요일 휴진
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">
                            <i class="fa-solid fa-circle-info"></i>
                            특이사항
                        </div>
                        <div class="info-value">점심시간 12:30 - 13:30<br>예약 접종 우선 진료</div>
                    </div>

					<!-- 지도 -->
					<div class="map-placeholder" id="map"
					     th:if="${#authorization.expression('isAuthenticated()')}">
					</div>

					<div class="map-placeholder login-guide"
					     th:unless="${#authorization.expression('isAuthenticated()')}">
					    <p>로그인 후 병원 위치를 확인할 수 있어요</p>
					</div>

                    <!-- 액션 버튼 -->
                    <div class="action-buttons">
                        <a href="/main/reservation" class="action-btn btn-primary">
							예약하기
                        </a>
                        <button class="action-btn btn-primary">
                            길찾기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<!-- footer -->
		<div th:replace="~{fragments/footer::footer}"></div>

		<!-- 모달 스크립트 -->
		<div th:replace="~{fragments/header::modalScript}"></div>
	
		<!-- 카카오 맵 api -->
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=678d4ee39238b156ada265c491ad2c8c&libraries=services,clusterer,drawing"></script>
	
	<script th:inline="javascript">
		/*<![CDATA[*/
		let map;
		let markers = [];
		
		document.addEventListener("DOMContentLoaded", function () {
		 // 지도 컨테이너 가져오기
		  const container = document.getElementById('map');
		  // 지도 옵션 설정 
		  const options = {
		    center: new kakao.maps.LatLng(37.5665, 126.9780), // 기본값(서울시청)
		    level: 5 // 확대레벨 ( 1 ~ 14, 숫자가 클수록 넓은 범위 )
		  };
		  // 지도 객체 생성
		  map = new kakao.maps.Map(container, options);
		
		// Thymeleaf에서 주소 받기
		// 컨트롤러에 model에 담음
		// Thymeleaf가 [[${userAddress}]]를 실제 주소 문자열로 변환
		const userAddress = /*[[${userAddress}]]*/ "";

		// 주소 → 좌표 변환 객체
		  const geocoder = new kakao.maps.services.Geocoder();

		  // 주소가 있을시
		  if (userAddress && userAddress.length > 0) {
			// 주소로 좌표검색
		    geocoder.addressSearch(userAddress, function(result, status) {
			  // 검색 성공시
		      if (status === kakao.maps.services.Status.OK) {
				// 좌표 객체 생성 (y = 위도, x = 경도)
		        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
		        // 지도 중심을 해당 좌표로 이동
		        map.setCenter(coords);

				// 지도 중심 설정 후 자동으로 소아과 검색
				searchHospital('소아과');
		      } else {
		        console.error("주소 변환 실패:", status);
		      }
		    });
		  }else {
            console.log("사용자 주소 정보가 없습니다.");
        }
	 });
	 
	 const ps = new kakao.maps.services.Places();
	 
	 function searchHospital(keyword){
		clearMarkers();
		
		ps.keywordSearch(keyword, placesSearchCB, {
			location: map.getCenter(),
			radius: 2000  // 2km 반경
		});
	 }

	 function placesSearchCB(data, status) {
		if(status === kakao.maps.services.Status.OK) {
			data.forEach(place => {
				const marker = new kakao.maps.Marker({
					map: map,
					position: new kakao.maps.LatLng(place.y, place.x)	
				});
				markers.push(marker);
				
				// 마커 클릭시 상세정보 업데이트
				kakao.maps.event.addListener(marker, 'click', function() {
					updateHospitalDetail(place);
				});
			});
		}
	 }
	 
	 function updateHospitalDetail(place){
		const detailContent = document.getElementById('detailContent');
		
		detailContent.innerHTML = `
			  <div class="info-row">
	              <div class="info-label">
	                  <i class="fa-solid fa-hospital"></i>
	                  병원명
	              </div>
	              <div class="info-value">${place.place_name}</div>
	          </div>
	
	          <div class="info-row">
	              <div class="info-label">
	                  <i class="fa-solid fa-location-dot"></i>
	                  주소
	              </div>
	              <div class="info-value">${place.address_name || place.road_address_name || '주소 정보 없음'}</div>
	          </div>
	
	          <div class="info-row">
	              <div class="info-label">
	                  <i class="fa-solid fa-phone"></i>
	                  전화번호
	              </div>
	              <div class="info-value">${place.phone || '전화번호 정보 없음'}</div>
	          </div>
	
			  
			  <div class="info-row">
			        <div class="info-label">
			          <i class="fa-solid fa-link"></i>
			          상세정보
			        </div>
			        <div class="info-value">
			          <a href="${place.place_url}" target="_blank">카카오맵에서 보기</a>
			        </div>
		      </div>
				  
	          <div class="info-row">
	              <div class="info-label">
	                  <i class="fa-solid fa-clock"></i>
	                  진료시간
	              </div>
	              <div class="info-value">
	                  평일 09:00 - 18:00<br>
	                  토요일 09:00 - 13:00<br>
	                  일요일 휴진
	              </div>
	          </div>
	
	          <div class="info-row">
	              <div class="info-label">
	                  <i class="fa-solid fa-circle-info"></i>
	                  특이사항
	              </div>
	              <div class="info-value">점심시간 12:30 - 13:30<br>예약 접종 우선 진료</div>
	          </div>
			  
			   <!-- 액션 버튼 -->
			   <div class="action-buttons">
			     <a href="/main/reservation" class="action-btn btn-primary">
			       예약하기
			     </a>
			     <a href="${place.place_url}" target="_blank" class="action-btn btn-primary">
			       길찾기
			     </a>
			   </div>
			  `
			  
			  // 지도 div를 다시 추가
		      const mapDiv = document.createElement('div');
		      mapDiv.className = 'map-placeholder';
		      mapDiv.id = 'map';
		      mapDiv.style.width = '100%';
		      mapDiv.style.height = '300px';
		      
		      // 액션 버튼 바로 위에 지도 삽입
		      const actionButtons = detailContent.querySelector('.action-buttons');
		      detailContent.insertBefore(mapDiv, actionButtons);
		      
		      // 지도 객체를 새로운 컨테이너에 재생성
		      const options = {
		          center: new kakao.maps.LatLng(place.y, place.x),
		          level: 4
		      };
		      map = new kakao.maps.Map(mapDiv, options);
		      
		      // 선택한 병원에 마커 표시
		      const marker = new kakao.maps.Marker({
		          map: map,
		          position: new kakao.maps.LatLng(place.y, place.x)
		      });
	 }
	 
	 
	 function clearMarkers() {
		markers.forEach(m => m.setMap(null));
		markers = [];
	 }
	 
	 	 
	 
	 /*]]>*/
	</script>	


		
		
    <script>
        // 병원 선택
        function selectHospital(element, index) {
            // 모든 아이템에서 active 클래스 제거
            document.querySelectorAll('.hospital-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 선택된 아이템에 active 클래스 추가
            element.classList.add('active');
            
            // 여기에 상세 정보 업데이트 로직 추가
            console.log('선택된 병원 인덱스:', index);
        }

        // 즐겨찾기 토글
        function toggleBookmark(event, index) {
            event.stopPropagation();
            const button = event.currentTarget;
            const icon = button.querySelector('i');
            
            // 즐겨찾기 토글 로직
            if (icon.classList.contains('fa-solid')) {
                icon.classList.remove('fa-solid');
                icon.classList.add('fa-regular');
                // alert('즐겨찾기에서 제거되었습니다.');
            } else {
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
               //  alert('즐겨찾기에 추가되었습니다.');
            }
        }
    </script>
</body>
</html>