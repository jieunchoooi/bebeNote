<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>진료예약 - 베베 접종 수첩</title>
    <link rel="stylesheet" href="/css/main/reservation.css" />
   <link rel="stylesheet" href="/css/login/insertModal.css" />
   <link rel="stylesheet" href="/css/fragments/layout.css" />
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
   <!-- header -->
      <div th:replace="~{fragments/header::header}"></div>
      
       <!-- 회원가입 모달 -->
       <div th:replace="~{fragments/insertModal::insertModal}"></div>
      
   <!--   로그인 모달-->
      <div th:replace="~{fragments/loginModal::loginModal}"></div>    

   
    <div class="bookmark-container">
        <!-- 왼쪽: 즐겨찾기 병원 목록 -->
        <div class="bookmark-section">
            <div class="section-title">
                <i class="fa-solid fa-clock"></i>
                진료 예약
            </div>
            
            <div class="hospital-list" id="hospitalList">
            
            <!-- 예약 영역 -->
            <div class="reservation-box">
                <div class="reservation-title">
                    날짜와 시간을 선택해주세요
                </div>

                <!-- 캘린더 헤더 -->
                <div class="calendar-header">
                    <button onclick="changeMonth(-1)">◀</button>
                    <span class="current-month" id="currentMonth"></span>
                    <button onclick="changeMonth(1)">▶</button>
                </div>

                <!-- 요일 -->
                <div class="calendar-weekdays">
                    <div class="weekday sunday">일</div>
                    <div class="weekday">월</div>
                    <div class="weekday">화</div>
                    <div class="weekday">수</div>
                    <div class="weekday">목</div>
                    <div class="weekday">금</div>
                    <div class="weekday saturday">토</div>
                </div>

                <!-- 날짜 -->
                <div class="calendar-days" id="calendarDays"></div>

                <!-- 시간 선택 -->
                <div class="reservation-section">
                    <div class="section-label">오전</div>
                    <div class="time-grid">
                        <button class="time-btn" onclick="selectTime(this)">09:00</button>
                        <button class="time-btn" onclick="selectTime(this)">09:30</button>
                        <button class="time-btn" onclick="selectTime(this)">10:00</button>
                        <button class="time-btn" onclick="selectTime(this)">10:30</button>
                        <button class="time-btn" onclick="selectTime(this)">11:00</button>
                        <button class="time-btn" onclick="selectTime(this)">11:30</button>
                    </div>
                  <div class="section-label">오후</div>
                  <div class="time-grid">
                  <button class="time-btn" onclick="selectTime(this)">13:00</button>
                  <button class="time-btn" onclick="selectTime(this)">13:30</button>
                  <button class="time-btn" onclick="selectTime(this)">14:00</button>
                  <button class="time-btn" onclick="selectTime(this)">14:30</button>
                  <button class="time-btn" onclick="selectTime(this)">15:00</button>
                  <button class="time-btn" onclick="selectTime(this)">15:30</button>
                  <button class="time-btn" onclick="selectTime(this)">16:00</button>
                  <button class="time-btn" onclick="selectTime(this)">16:30</button>
                  <button class="time-btn" onclick="selectTime(this)">17:00</button>
                  </div>
                </div>

                <!-- 예약 버튼 -->
                <button class="reserve-btn" onclick="makeReservation()">
                    예약하기
                </button>
            </div>

            </div>
        </div>

        <!-- 오른쪽: 검색 및 상세 정보 -->
        <div class="info-section">

            <!-- 병원 상세 정보 -->
            <div class="hospital-detail-card">
                <div class="detail-header">
                    <div class="detail-title">병원 정보</div>
                    <i class="fa-solid fa-star bookmark-star"></i>
                </div>

                <div class="detail-content" id="detailContent">
                    <div class="info-row">
                        <div class="info-label">
                            <i class="fa-solid fa-hospital"></i>
                            병원명
                        </div>
                        <div class="info-value">병원을 선택해주세요</div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">
                            <i class="fa-solid fa-location-dot"></i>
                            주소
                        </div>
                        <div class="info-value">-</div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">
                            <i class="fa-solid fa-phone"></i>
                            전화번호
                        </div>
                        <div class="info-value">-</div>
                    </div>

                    <!-- 지도 -->
					<div class="map-placeholder" id="map"
					     th:if="${#authorization.expression('isAuthenticated()')}">
					     <p>병원을 선택하면 지도가 표시됩니다</p>
					</div>

					<div class="map-placeholder login-guide"
					     th:unless="${#authorization.expression('isAuthenticated()')}">
					    <p>로그인 후 병원 위치를 확인할 수 있어요</p>
					</div>
                </div>
            </div>
        </div>
    </div>

   <!-- footer -->
      <div th:replace="~{fragments/footer::footer}"></div>

      <!-- 모달 스크립트 -->
      <div th:replace="~{fragments/header::modalScript}"></div>
   
<!--	카카오 맵 api-->
      <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=678d4ee39238b156ada265c491ad2c8c&libraries=services,clusterer,drawing"></script>
	  
	  <script th:inline="javascript">
	  	/*<![CDATA[*/
	  	
	  	// CSRF 토큰 가져오기
	    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
	    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
	  	
	  	let map; // 카카오맵 객체 담을 변수
	  	let currentHospital = null; // 현재 선택된 병원 정보
	  	
	  	document.addEventListener("DOMContentLoaded", function () {
		  	// 지도 컨테이너 가져오기
		  	const container = document.getElementById('map');
		  	
		  	// 로그인 여부 확인 (지도 컨테이너가 있는지로 판단)
		  	if (container && !container.classList.contains('login-guide')) {
			  	// 지도 옵션 설정 
			  	const options = {
			  	    center: new kakao.maps.LatLng(37.5665, 126.9780), // 기본값(서울시청)
			  	    level: 5 // 확대레벨
			  	};
			  	// 지도 객체 생성
			  	map = new kakao.maps.Map(container, options);
		  	}
	  	
		  	// sessionStorage에서 병원 정보 가져오기
		    const selectedHospital = sessionStorage.getItem('selectedHospital');
		    
		    if (selectedHospital) {
		        const hospitalInfo = JSON.parse(selectedHospital);
		        currentHospital = hospitalInfo; // 전역 변수에 저장
		        
		        // 오른쪽 상세정보 업데이트
		        updateHospitalDetail(hospitalInfo);
		    }
		    
		    // 캘린더 렌더링
		    renderCalendar();
		});
		
		// 병원 상세정보 업데이트 함수
		function updateHospitalDetail(hospitalInfo) {
		    const detailContent = document.getElementById('detailContent');
		    detailContent.innerHTML = `
		        <div class="info-row">
		            <div class="info-label">
		                <i class="fa-solid fa-hospital"></i>
		                병원명
		            </div>
		            <div class="info-value">${hospitalInfo.place_name}</div>
		        </div>

		        <div class="info-row">
		            <div class="info-label">
		                <i class="fa-solid fa-location-dot"></i>
		                주소
		            </div>
		            <div class="info-value">${hospitalInfo.address_name}</div>
		        </div>

		        <div class="info-row">
		            <div class="info-label">
		                <i class="fa-solid fa-phone"></i>
		                전화번호
		            </div>
		            <div class="info-value">${hospitalInfo.phone || '전화번호 정보 없음'}</div>
		        </div>

		        <div class="info-row">
		            <div class="info-label">
		                <i class="fa-solid fa-clock"></i>
		                진료여부
		            </div>
		            <div class="info-value">
		                <a href="${hospitalInfo.place_url || '#'}" 
		                   target="_blank" 
		                   style="display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; background: #E8A5A5; color: #FFFFFF; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px;">
		                    카카오맵에서 보기
		                </a>
		            </div>
		        </div>

		        <!-- 지도 -->
		        <div class="map-placeholder" id="hospitalMap" style="width: 100%; height: 300px; margin-top: 20px; border: none;"></div>

		        <!-- 액션 버튼 -->
		        <div class="action-buttons">
		            <a href="https://map.kakao.com/link/to/${hospitalInfo.place_name},${hospitalInfo.y},${hospitalInfo.x}" 
		               target="_blank" 
		               class="action-btn reserve-btn">
		                <i class="fa-solid fa-location-arrow"></i>
		                길찾기
		            </a>
		        </div>
		    `;
		    
		    // 지도 재생성 및 마커 표시
		    const hospitalMapDiv = document.getElementById('hospitalMap');
		    if(hospitalMapDiv) {
		        const mapOptions = {
		            center: new kakao.maps.LatLng(hospitalInfo.y, hospitalInfo.x),
		            level: 4
		        };
		        const hospitalMap = new kakao.maps.Map(hospitalMapDiv, mapOptions);
		        
		        // 마커 표시
		        new kakao.maps.Marker({
		            map: hospitalMap,
		            position: new kakao.maps.LatLng(hospitalInfo.y, hospitalInfo.x)
		        });
		    }
		}
	  
	    /*]]>*/
	   </script>	
	  
    <script>
        // ============ 캘린더 관련 코드 ============
        let currentDate = new Date();
        let selectedDate = null;
        let selectedTime = null;
        let reservedTimes = []; // 예약된 시간 목록

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = `${year}.${month + 1}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            // 이전 달 날짜들
            const firstDayOfWeek = firstDay.getDay();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevLastDay.getDate() - i;
                const dayElement = createDayElement(day, 'other-month');
                calendarDays.appendChild(dayElement);
            }
            
            // 이번 달 날짜들
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDateCheck = new Date(year, month, day);
                const isToday = currentDateCheck.toDateString() === today.toDateString();
                const isPast = currentDateCheck < today;
                const dayOfWeek = currentDateCheck.getDay();
                
                let className = '';
                if (isToday) className += 'today ';
                if (dayOfWeek === 0) className += 'sunday ';
                if (dayOfWeek === 6) className += 'saturday ';
                if (isPast) className += 'disabled ';
                
                const dayElement = createDayElement(day, className);
                
                if (!isPast) {
                    dayElement.onclick = () => selectDate(currentDateCheck, dayElement);
                }
                
                calendarDays.appendChild(dayElement);
            }
            
            // 다음 달 날짜들
            const remainingDays = 42 - calendarDays.children.length;
            for (let day = 1; day <= remainingDays; day++) {
                const dayElement = createDayElement(day, 'other-month');
                calendarDays.appendChild(dayElement);
            }
        }

        function createDayElement(day, className = '') {
            const div = document.createElement('div');
            div.className = `day ${className}`;
            div.textContent = day;
            return div;
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
            
            // 선택 초기화
            selectedDate = null;
            selectedTime = null;
            reservedTimes = [];
            document.querySelectorAll('.time-btn.active').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 모든 시간 버튼 다시 활성화
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('disabled');
                btn.onclick = () => selectTime(btn);
            });
        }

        async function selectDate(date, element) {
            // 선택 표시
            document.querySelectorAll('.day.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            if (!element.classList.contains('today')) {
                element.classList.add('selected');
            }
            
            selectedDate = date;
            selectedTime = null;
            
            // 선택한 시간 초기화
            document.querySelectorAll('.time-btn.active').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 해당 날짜의 예약된 시간 조회
            await loadReservedTimes(date);
            
            // 당일인 경우 지나간 시간 비활성화
            checkPastTimes(date);
            
            console.log('선택된 날짜:', date.toLocaleDateString());
        }

        async function loadReservedTimes(date) {
            if (!currentHospital) {
                console.log('병원 정보 없음');
                return;
            }
            
            const dateStr = formatDate(date);
            
            try {
                const response = await fetch(`/api/reservations/reserved-times?hospitalName=${encodeURIComponent(currentHospital.place_name)}&date=${dateStr}`);
                const result = await response.json();
                
                if (result.success) {
                    reservedTimes = result.data;
                    updateTimeButtons();
                }
            } catch (error) {
                console.error('예약 시간 조회 실패:', error);
            }
        }

        function updateTimeButtons() {
            const timeButtons = document.querySelectorAll('.time-btn');
            
            timeButtons.forEach(btn => {
                const time = btn.textContent.trim();
                
                // 기존 disabled 클래스 제거 및 이벤트 재설정
                btn.classList.remove('disabled');
                btn.onclick = () => selectTime(btn);
                
                // 예약된 시간이면 disabled 처리
                if (reservedTimes.includes(time)) {
                    btn.classList.add('disabled');
                    btn.onclick = null;
                }
            });
        }

        // 당일 지나간 시간 비활성화 함수
        function checkPastTimes(selectedDate) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const selected = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
            
            // 선택한 날짜가 오늘이 아니면 return
            if (selected.getTime() !== today.getTime()) {
                return;
            }
            
            // 현재 시간 (분 단위까지)
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // 모든 시간 버튼 확인
            const timeButtons = document.querySelectorAll('.time-btn');
            
            timeButtons.forEach(btn => {
                const timeText = btn.textContent.trim(); // "09:00", "13:30" 등
                const [hour, minute] = timeText.split(':').map(Number);
                
                // 지나간 시간인지 확인
                const isPast = (hour < currentHour) || 
                              (hour === currentHour && minute <= currentMinute);
                
                if (isPast) {
                    btn.classList.add('disabled');
                    btn.onclick = null;
                }
            });
        }

        function selectTime(button) {
            if (button.classList.contains('disabled')) return;
            
            document.querySelectorAll('.time-btn.active').forEach(btn => {
                btn.classList.remove('active');
            });
            
            button.classList.add('active');
            selectedTime = button.textContent.trim();
            console.log('선택된 시간:', selectedTime);
        }

        async function makeReservation() {
            if (!selectedDate) {
                alert('날짜를 선택해주세요.');
                return;
            }
            if (!selectedTime) {
                alert('시간을 선택해주세요.');
                return;
            }
            if (!currentHospital) {
                alert('병원 정보를 찾을 수 없습니다.\n병원 검색 페이지에서 병원을 선택해주세요.');
                return;
            }
            
            const reservationData = {
                hospitalName: currentHospital.place_name,
                hospitalAddress: currentHospital.address_name,
                hospitalPhone: currentHospital.phone || '',
                kakaoPlaceId: currentHospital.id,
                reservationDate: formatDate(selectedDate),
                reservationTime: selectedTime,
                memo: ''
            };
            
            try {
                const response = await fetch('/api/reservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(reservationData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`예약이 완료되었습니다!\n\n병원: ${currentHospital.place_name}\n날짜: ${selectedDate.toLocaleDateString()}\n시간: ${selectedTime}`);
                    
                    // 예약 목록 페이지로 이동 (또는 페이지 새로고침)
                    // location.href = '/mypage/reservations';
                    location.reload(); // 또는 페이지 새로고침
                } else {
                    alert(result.message || '예약에 실패했습니다.');
                }
            } catch (error) {
                console.error('예약 실패:', error);
                
                // 401 에러인 경우 (로그인 필요)
                if (error.message && error.message.includes('401')) {
                    alert('로그인이 필요한 서비스입니다.');
                } else {
                    alert('예약 처리 중 오류가 발생했습니다.');
                }
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    </script>
</body>
</html>