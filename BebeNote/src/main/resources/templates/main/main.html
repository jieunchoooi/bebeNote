<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>베베 접종 수첩</title>
<link rel="stylesheet" href="/css/main/main.css" />
<link rel="stylesheet" href="/css/login/insertModal.css" />
<link rel="stylesheet" href="/css/fragments/layout.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  integrity="sha512-..."
  crossorigin="anonymous"
  referrerpolicy="no-referrer"/>
</head>
<body>

	<!-- header -->
	<div th:replace="~{fragments/header::header}"></div>

    <!-- 회원가입 모달 -->
    <div th:replace="~{fragments/insertModal::insertModal}"></div>

	<!-- 로그인 모달 -->
	<div th:replace="~{fragments/loginModal::loginModal}"></div>
	
	<!-- 자녀추가 모달 -->
	<div th:replace="~{fragments/addChildModal::addChildModal}"></div>

    <div class="main-container">
        <div class="main-top-row">
            <div class="main-baby-info-card">
                <div class="main-profile-section">
                    <div class="main-profile-image"><i class="fa-solid fa-child-reaching"></i></div>
                    <div class="main-profile-info">
						<div sec:authorize="isAuthenticated()">
							<a href="#" onclick="openAddChildModal(); return false;" class="main-birth-info">자녀 추가</a>
							
						<!-- 자녀가 여러 명일 때 선택 UI -->
						    <div th:if="${children != null and children.size() > 1}" class="child-selector">
						        <select id="childSelect" onchange="selectChild()" class="child-select-dropdown">
						            <option th:each="child, iterStat : ${children}" 
						                    th:value="${iterStat.index}" 
						                    th:text="${child.name}"
						                    th:selected="${iterStat.index == 0}">
						            </option>
						        </select>
						    </div>
						<!-- 자녀정보 표시영역 -->
							<div th:each="child, iterStat : ${children}" 
						         th:id="'child-info-' + ${iterStat.index}"
						         class="child-info"
						         th:style="${iterStat.index == 0 ? 'display:block' : 'display:none'}">
								<div class="main-baby-name">
		                            <span class="main-name-text" th:text="${child.name}"></span>
		                        </div>
		                        <div class="main-birth-info"><span th:text="${child.birth_date}"></span>(<span th:text="${child.gender}"></span>)</div>
		                        <div class="main-birth-info">태어난지 <span th:text="${child.ageInMonths}"></span>개월 됐어요.</div>
							</div>
						</div>
						
						<div sec:authorize="isAnonymous()">
							<div class="main-baby-name">
	                            <span class="main-name-text">로그인 해주세요.</span>
	                        </div>
						</div>
                    </div>
                </div>
            </div>

            <div class="main-ai-card">
                <div class="main-ai-header">
                    <div class="main-ai-icon"><i class="fa-solid fa-robot"></i></div>
                    <div class="main-ai-title">AI 맞춤 추천</div>
                </div>
                <div class="main-ai-content">
                    <div class="main-ai-message">
                        <span class="main-ai-highlight">B형간염 2차</span> 접종을
                        <span class="main-ai-date">1/30 정도</span>에 접종하는 것을 추천합니다
                    </div>
                    <div class="main-ai-action">
                        <button class="main-ai-button">병원 예약하기</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-middle-row">
            <div class="main-card">
                <div class="main-card-title">예약한 병원</div>
                <div class="main-card-content"></div>
					<div class="main-hospital-item" onclick="selectMainHospital(this, 0)">
				         <div class="main-hospital-header">
				              <div class="main-hospital-name">지은소아과</div>
				              <button class="main-bookmark-btn" onclick="toggleMainBookmark(event, 0)">
				                 <i class="fa-solid fa-star"></i>
				              </button>
				         </div>
				    <div class="main-hospital-info">
				    <div><i class="fa-solid fa-phone"></i> 051-1234-5678</div>
				 </div>
				 </div>
            </div>

			<div class="main-card">
			    <div class="main-card-title">즐겨찾기 소아과</div>

			    <!-- 즐겨찾기 있을 때 -->
			    <div th:if="${!#lists.isEmpty(userBookmark)}" class="main-card-content">

			        <div th:each="bookmark : ${userBookmark}"
			             class="main-hospital-item hospital-item"
			             onclick="setCurrentHospitalFromData(this)">

			            <div class="main-hospital-header">
			                <div class="main-hospital-name"
			                     th:text="${bookmark.hospitalName}"></div>

			                <button class="main-bookmark-btn">
			                    <i class="fa-solid fa-star"></i>
			                </button>
			            </div>

			            <div class="main-hospital-info">
			                <div>
			                    <i class="fa-solid fa-location-dot"></i>
			                    <span th:text="${bookmark.address}"></span>
			                </div>
			                <div>
			                    <i class="fa-solid fa-phone"></i>
			                    <span th:text="${bookmark.phone}"></span>
			                </div>
			            </div>

			        </div>
			    </div>
			</div>


            <div class="main-card">
                <div class="main-card-title">근처 소아과</div>
                <div class="main-card-content"></div>
				<div class="main-hospital-item" onclick="selectMainHospital(this, 0)">
				    <div class="main-hospital-header">
				      <div class="main-hospital-name">지은소아과</div>
				            <button class="main-bookmark-btn" onclick="toggleMainBookmark(event, 0)">
				             <i class="fa-solid fa-star"></i>
				       </button>
				 </div>
				   <div class="main-hospital-info">
				   <div><i class="fa-solid fa-phone"></i> 051-1234-5678</div>
				 </div>
			 </div>
            </div>
        </div>

        <div class="main-section">
            <div class="main-title">접종 수첩</div>
            <div class="main-vaccination-table-wrapper">
                <table class="main-vaccination-table">
                    <thead>
                        <tr>
                            <th>대상전염병</th>
                            <th>1차</th>
                            <th>2차</th>
                            <th>3차</th>
                            <th>4차</th>
                            <th>5차</th>
                            <th>6차</th>
                        </tr>
                    </thead>
					<tbody>
					    <tr th:each="vaccine : ${vaccines}">
					        <!-- 대상전염병 -->
					        <td th:text="${vaccine.vaccine_name}" class="disease-name"></td>
					
					        <!-- 1차 ~ 6차 고정 -->
					        <td th:each="dose, stat : ${doses}"
					            th:if="${stat.index < 6}"
					            th:with="key=${vaccine.vaccine_id + '_' + dose.dose_id},
					                     record=${vaccineRecords.get(key)}"
					            th:classappend="${record != null ? 'vaccine-empty saved' : 'vaccine-empty'}"
					            th:data-vaccine-id="${vaccine.vaccine_id}"
					            th:data-dose-id="${dose.dose_id}">
					
					            <!-- 저장된 데이터가 있으면 표시 -->
					            <div th:if="${record != null}" class="vaccination-info" >
					                <div class="hospital-name" th:text="${record.hospital}">병원명</div>
					                <div class="vaccination-date" th:text="${record.vaccinated_date}">날짜</div>
					                <div class="vaccine-name" th:text="${record.vaccine_product}">백신명</div>
					            </div>
					        </td>
					    </tr>
					</tbody>
                </table>
            </div>
        </div>
    </div>

	<!-- footer -->
	<div th:replace="~{fragments/footer::footer}"></div>

	<!-- 모달 스크립트 -->
	<div th:replace="~{fragments/header::modalScript}"></div>

    <script>
        // 메인 페이지 병원 선택
        function selectMainHospital(element, index) {
            console.log('선택된 병원 인덱스:', index);
            // 필요한 동작 추가
        }

        // 메인 페이지 즐겨찾기 토글
        function toggleMainBookmark(event, index) {
            event.stopPropagation();
            const button = event.currentTarget;
            const icon = button.querySelector('i');
            
            if (icon.classList.contains('fa-solid')) {
                icon.classList.remove('fa-solid');
                icon.classList.add('fa-regular');
                console.log('즐겨찾기 해제:', index);
            } else {
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
                console.log('즐겨찾기 추가:', index);
            }
        }
		
		
		// 자녀 선택 함수
	   function selectChild() {
	       const select = document.getElementById('childSelect');
	       const selectedIndex = select.value;
	       
	       // 모든 자녀 정보 숨기기
	       const allChildren = document.querySelectorAll('.child-info');
	       allChildren.forEach(child => {
	           child.style.display = 'none';
	       });
	       
	       // 선택된 자녀만 표시
	       const selectedChild = document.getElementById('child-info-' + selectedIndex);
	       if (selectedChild) {
	           selectedChild.style.display = 'block';
	       }
	   }
	   
	   
	   
	   
    </script>
</body>
</html>