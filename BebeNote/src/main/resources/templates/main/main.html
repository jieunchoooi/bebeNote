<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>베베 접종 수첩</title>
<link rel="stylesheet" href="/css/main/main.css" />
<link rel="stylesheet" href="/css/login/insertModal.css" />
<link rel="stylesheet" href="/css/fragments/layout.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  integrity="sha512-..."
  crossorigin="anonymous"
  referrerpolicy="no-referrer"/>
</head>
<body>

	<!-- header -->
	<div th:replace="~{fragments/header::header}"></div>

    <!-- 회원가입 모달 -->
    <div th:replace="~{fragments/insertModal::insertModal}"></div>

	<!-- 로그인 모달 -->
	<div th:replace="~{fragments/loginModal::loginModal}"></div>
	
	<!-- 자녀추가 모달 -->
	<div th:replace="~{fragments/addChildModal::addChildModal}"></div>

    <div class="main-container">
        <div class="main-top-row">
            <div class="main-baby-info-card">
                <div class="main-profile-section">
                    <div class="main-profile-image"><i class="fa-solid fa-child-reaching"></i></div>
                    <div class="main-profile-info">
						<div sec:authorize="isAuthenticated()">
							<a href="#" onclick="openAddChildModal(); return false;" class="main-birth-info">자녀 추가</a>
							
						<!-- 자녀가 여러 명일 때 선택 UI -->
						    <div th:if="${children != null and children.size() > 1}" class="child-selector">
						        <select id="childSelect" onchange="selectChild()" class="child-select-dropdown">
						            <option th:each="child, iterStat : ${children}" 
						                    th:value="${iterStat.index}" 
						                    th:text="${child.name}"
						                    th:selected="${iterStat.index == 0}">
						            </option>
						        </select>
						    </div>
						<!-- 자녀정보 표시영역 -->
							<div th:each="child, iterStat : ${children}" 
						         th:id="'child-info-' + ${iterStat.index}"
						         class="child-info"
						         th:style="${iterStat.index == 0 ? 'display:block' : 'display:none'}">
								<div class="main-baby-name">
		                            <span class="main-name-text" th:text="${child.name}"></span>
		                        </div>
		                        <div class="main-birth-info"><span th:text="${child.birth_date}"></span>(<span th:text="${child.gender}"></span>)</div>
		                        <div class="main-birth-info">태어난지 <span th:text="${child.ageInMonths}"></span>개월 됐어요.</div>
							</div>
						</div>
						
						<div sec:authorize="isAnonymous()">
							<div class="main-baby-name">
	                            <span class="main-name-text">로그인 해주세요.</span>
	                        </div>
						</div>
                    </div>
                </div>
            </div>

            <div class="main-ai-card">
                <div class="main-ai-header">
                    <div class="main-ai-icon"><i class="fa-solid fa-robot"></i></div>
                    <div class="main-ai-title">AI 맞춤 추천</div>
                </div>
                <div class="main-ai-content">
                    <div class="main-ai-message">
                        접종 정보가 없습니다.
                    </div>
                </div>
            </div>
        </div>

        <div class="main-middle-row">
            <div class="main-card">
                <div class="main-card-title">예약한 병원</div>
                <div class="main-card-content"></div>
					<div class="main-hospital-item" onclick="selectMainHospital(this, 0)">
				         <div class="main-hospital-header">
				              <div class="main-hospital-name">지은소아과</div>
				              <button class="main-bookmark-btn" onclick="toggleMainBookmark(event, 0)">
				                 <i class="fa-solid fa-star"></i>
				              </button>
				         </div>
				    <div class="main-hospital-info">
				    <div><i class="fa-solid fa-phone"></i> 051-1234-5678</div>
				 </div>
				 </div>
            </div>

			<div class="main-card">
			    <div class="main-card-title">즐겨찾기 소아과</div>

			    <!-- 즐겨찾기 있을 때 -->
			    <div th:if="${!#lists.isEmpty(userBookmark)}" class="main-card-content">

			        <div th:each="bookmark : ${userBookmark}"
			             class="main-hospital-item hospital-item"
						 th:data-kakao-place-id="${bookmark.kakaoPlaceId}"
				         th:data-hospital-name="${bookmark.hospitalName}"
				         th:data-address="${bookmark.address}"
				         th:data-phone="${bookmark.phone}"
				         th:data-latitude="${bookmark.latitude}"
				         th:data-longitude="${bookmark.longitude}"
				         onclick="goToBookmarkDetailFromElement(this)">

			            <div class="main-hospital-header">
			                <div class="main-hospital-name"
			                     th:text="${bookmark.hospitalName}"></div>

			                <button class="main-bookmark-btn"
									th:data-kakao-place-id="${bookmark.kakaoPlaceId}"
							        onclick="removeBookmarkFromElement(event, this)">
			                    <i class="fa-solid fa-star"></i>
			                </button>
			            </div>

			            <div class="main-hospital-info">
			                <div>
			                    <i class="fa-solid fa-location-dot"></i>
			                    <span th:text="${bookmark.address}"></span>
			                </div>
			                <div>
			                    <i class="fa-solid fa-phone"></i>
			                    <span th:text="${bookmark.phone}"></span>
			                </div>
			            </div>

			        </div>
			    </div>
				<div th:if="${#lists.isEmpty(userBookmark)}" class="main-card-content">
					<span>즐겨찾기에 등록된 병원이 없습니다.</span>
				</div>
			</div>


            <div class="main-card">
                <div class="main-card-title">근처 소아과</div>
			        <!-- 근처 소아과 목록 -->
			        <div id="nearbyHospitalList" class="main-card-content">
			            <div class="loading-message">
			                <i class="fa-solid fa-spinner fa-spin"></i>
			                근처 소아과를 검색 중입니다...
			            </div>
			        </div>
            </div>
        </div>

        <div class="main-section">
            <div class="main-title">접종 수첩</div>
            <div class="main-vaccination-table-wrapper"	th:if="${!hasChild}">
			    <p>등록된 자녀가 없습니다. 자녀를 먼저 등록해주세요.</p>
			</div>
            <div class="main-vaccination-table-wrapper"	th:if="${hasChild}">
                <table class="main-vaccination-table">
                    <thead>
                        <tr>
                            <th>대상전염병</th>
                            <th>1차</th>
                            <th>2차</th>
                            <th>3차</th>
                            <th>4차</th>
                            <th>5차</th>
                            <th>6차</th>
                        </tr>
                    </thead>
					<tbody>
					    <tr th:each="vaccine : ${vaccines}">
					        <!-- 대상전염병 -->
					        <td th:text="${vaccine.vaccine_name}" class="disease-name"></td>
					
					        <!-- 1차 ~ 6차 고정 -->
					        <td th:each="dose, stat : ${doses}"
					            th:if="${stat.index < 6}"
					            th:with="key=${vaccine.vaccine_id + '_' + dose.dose_id},
					                     record=${vaccineRecords.get(key)}"
					            th:classappend="${record != null ? 'vaccine-empty saved' : 'vaccine-empty'}"
					            th:data-vaccine-id="${vaccine.vaccine_id}"
					            th:data-dose-id="${dose.dose_id}">
					
					            <!-- 저장된 데이터가 있으면 표시 -->
					            <div th:if="${record != null}" class="vaccination-info" >
					                <div class="hospital-name" th:text="${record.hospital}">병원명</div>
					                <div class="vaccination-date" th:text="${record.vaccinated_date}">날짜</div>
					                <div class="vaccine-name" th:text="${record.vaccine_product}">백신명</div>
					            </div>
					        </td>
					    </tr>
					</tbody>
                </table>
			</div>
            </div>
        </div>
    </div>

	<!-- footer -->
	<div th:replace="~{fragments/footer::footer}"></div>

	<!-- 모달 스크립트 -->
	<div th:replace="~{fragments/header::modalScript}"></div>

	<!-- 카카오 맵 API -->
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=678d4ee39238b156ada265c491ad2c8c&libraries=services"></script>
	
	<script th:inline="javascript">
	/*<![CDATA[*/
        // 메인 페이지 병원 선택
        function selectMainHospital(element, index) {
            console.log('선택된 병원 인덱스:', index);
            // 필요한 동작 추가
        }

        // 메인 페이지 즐겨찾기 토글
        function toggleMainBookmark(event, index) {
            event.stopPropagation();
            const button = event.currentTarget;
            const icon = button.querySelector('i');
            
            if (icon.classList.contains('fa-solid')) {
                icon.classList.remove('fa-solid');
                icon.classList.add('fa-regular');
                console.log('즐겨찾기 해제:', index);
            } else {
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
                console.log('즐겨찾기 추가:', index);
            }
        }
		
		
		// 자녀 선택 함수
	   function selectChild() {
	       const select = document.getElementById('childSelect');
	       const selectedIndex = select.value;
	       
	       // 모든 자녀 정보 숨기기
	       const allChildren = document.querySelectorAll('.child-info');
	       allChildren.forEach(child => {
	           child.style.display = 'none';
	       });
	       
	       // 선택된 자녀만 표시
	       const selectedChild = document.getElementById('child-info-' + selectedIndex);
	       if (selectedChild) {
	           selectedChild.style.display = 'block';
	       }
	   }
	   
	   
	   // AI 추천 함수
	   
	   const children = /*[[${children}]]*/ [];
	   const hasChild = /*[[${hasChild}]]*/ false;

	   console.log('Children data:', children);
	   console.log('Has child:', hasChild);

	   
	   function getAIRecommendation() {
	       // 자녀가 없으면 종료
	       if (!hasChild || !children || children.length === 0) {
	           console.log('등록된 자녀가 없어 AI 추천을 건너뜁니다.');
	           const aiText = document.getElementById('ai-recommendation-text');
	           if (aiText) {
	               aiText.textContent = '자녀를 등록하면 AI 맞춤 추천을 받을 수 있습니다.';
	           }
	           return;
	       }
	       
	       // 첫 번째 자녀의 ID 가져오기
	       const childId = children[0].child_id;
	       
	       console.log('AI 추천 요청 - Child ID:', childId);
	       
	       // AI 추천 텍스트 영역 찾기
	       const aiText = document.querySelector('.main-ai-message');
	       if (!aiText) {
	           console.error('AI 추천 텍스트 영역을 찾을 수 없습니다.');
	           return;
	       }
	       
	       // 로딩 표시
	       aiText.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> AI가 추천을 생성하고 있습니다...';
	       
	       // API 호출
	       fetch(`/api/ai-recommendation/${childId}`)
	           .then(response => {
	               if (!response.ok) {
	                   throw new Error('API 응답 오류: ' + response.status);
	               }
	               return response.json();
	           })
	           .then(data => {
	               console.log('AI 추천 결과:', data);
	               aiText.textContent = data.recommendation;
	           })
	           .catch(error => {
	               console.error('AI 추천 오류:', error);
	               aiText.textContent = '추천을 가져오는 중 오류가 발생했습니다.';
	           });
	   }

	   // 페이지 로드 시 자동 실행
	   document.addEventListener('DOMContentLoaded', function() {
	       console.log('페이지 로드 완료');
	       
	       // 자녀가 있을 때만 AI 추천 실행
	       if (hasChild && children && children.length > 0) {
	           getAIRecommendation();
	       } else {
	           console.log('자녀 정보가 없어 AI 추천을 건너뜁니다.');
	       }
	   });

	   
	   // 사용자 주소 가져오기
	       const userAddress = /*[[${userAddress}]]*/ "";
	       
	       // 페이지 로드 시 근처 소아과 검색
	       document.addEventListener("DOMContentLoaded", function() {
	           if (userAddress && userAddress.length > 0) {
	               searchNearbyHospitalsForMain(userAddress);
	           } else {
	               document.getElementById('nearbyHospitalList').innerHTML = 
	                   '<div class="empty-message"><i class="fa-regular fa-hospital"></i><p>주소를 등록하면 근처 소아과를 확인할 수 있습니다.</p></div>';
	           }
	       });
	       
	       // 근처 소아과 검색 함수
	       function searchNearbyHospitalsForMain(address) {
	           const geocoder = new kakao.maps.services.Geocoder();
	           
	           // 주소 → 좌표 변환
	           geocoder.addressSearch(address, function(result, status) {
	               if (status === kakao.maps.services.Status.OK) {
	                   const coords = {
	                       lat: result[0].y,
	                       lng: result[0].x
	                   };
	                   
	                   // Places API로 근처 소아과 검색
	                   const ps = new kakao.maps.services.Places();
	                   
	                   ps.keywordSearch('소아과', function(data, status) {
	                       if (status === kakao.maps.services.Status.OK) {
	                           displayNearbyHospitals(data);
	                       } else {
	                           document.getElementById('nearbyHospitalList').innerHTML = 
	                               '<div class="empty-message"><i class="fa-regular fa-hospital"></i><p>근처 소아과를 찾을 수 없습니다.</p></div>';
	                       }
	                   }, {
	                       location: new kakao.maps.LatLng(coords.lat, coords.lng),
	                       radius: 2000,
	                       size: 15
	                   });
	               } else {
	                   document.getElementById('nearbyHospitalList').innerHTML = 
	                       '<div class="empty-message"><i class="fa-regular fa-hospital"></i><p>주소 검색에 실패했습니다.</p></div>';
	               }
	           });
	       }
	       
	       // 근처 소아과 화면에 표시
	       function displayNearbyHospitals(hospitals) {
	           const listContainer = document.getElementById('nearbyHospitalList');
	           listContainer.innerHTML = '';
	           
	           if (hospitals.length === 0) {
	               listContainer.innerHTML = '<div class="empty-message"><i class="fa-regular fa-hospital"></i><p>근처 소아과를 찾을 수 없습니다.</p></div>';
	               return;
	           }
	           
	           hospitals.forEach((hospital, index) => {
	               const hospitalItem = document.createElement('div');
	               hospitalItem.className = 'main-hospital-item';
	               hospitalItem.onclick = function() {
	                   // 근처 소아과 페이지로 이동
	                   window.location.href = '/nearHospital';
	               };
	               
	               // 즐겨찾기 여부 확인 (선택사항)
	               const isBookmarked = false; // 추후 구현
	               
	               hospitalItem.innerHTML = `
	                   <div class="main-hospital-header">
	                       <div class="main-hospital-name">${hospital.place_name}</div>
	                       <button class="main-bookmark-btn" onclick="event.stopPropagation(); toggleMainBookmark(event, ${index}, ${JSON.stringify(hospital).replace(/"/g, '&quot;')})">
	                           <i class="fa-solid fa-star"></i>
	                       </button>
	                   </div>
	                   <div class="main-hospital-info">
	                       <div><i class="fa-solid fa-location-dot"></i> ${hospital.address_name || hospital.road_address_name || '주소 정보 없음'}</div>
	                       <div><i class="fa-solid fa-phone"></i> ${hospital.phone || '전화번호 정보 없음'}</div>
	                   </div>
	               `;
	               
	               listContainer.appendChild(hospitalItem);
	           });
	       }
	   
		   // 즐겨찾기 병원 상세 페이지로 이동 (element에서 데이터 가져오기)
		   function goToBookmarkDetailFromElement(element) {
		       const kakaoPlaceId = element.dataset.kakaoPlaceId;
		       window.location.href = '/headerMenu/bookmark?selectedHospital=' + kakaoPlaceId;
		   }

		
		   
	   /*]]>*/
    </script>
</body>
</html>