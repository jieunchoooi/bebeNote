<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<title>마이페이지 | 베베 접종 수첩</title>

<link rel="stylesheet" href="/css/fragments/layout.css" />
<link rel="stylesheet" href="/css/login/insertModal.css" />
<link rel="stylesheet" href="/css/myPage/info.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>


</head>

<body>

<!-- header -->
<div th:replace="~{fragments/header::header}"></div>
<!-- 회원가입 모달 -->
<div th:replace="~{fragments/insertModal::insertModal}"></div>
<!-- 로그인 모달 -->
<div th:replace="~{fragments/loginModal::loginModal}"></div> 
<!-- content -->
<div class="mypage-wrapper">

    <!-- 사이드바 -->
    <aside class="mypage-sidebar">
        <h3>자녀 정보</h3>
        <ul class="sidebar-menu">
            <li><a href="/myPage/info" class="active">자녀 정보</a></li>
            <li><a href="/myPage/myHospital">나의 병원</a></li>
            <li><a href="/myPage/payHistory">결제 내역</a></li>
            <li><a href="/myPage/payControl">결제 관리</a></li>
        </ul>
    </aside>

    <!-- 콘텐츠 -->
    <section class="mypage-content">

		<!-- 자녀 정보 카드 -->
		<div class="mypage-card child-card" id="childCard" th:each="child : ${childInfo}">
		    <div class="child-avatar">
		        <!-- child_img가 있으면 이미지 표시, 없으면 아이콘 표시 -->
		        <img th:if="${child.child_img != null}" 
		             th:src="@{${child.child_img}}" 
		             alt="프로필 사진" 
		             style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
		        <i th:if="${child.child_img == null}" 
		           class="fa-solid fa-child-reaching"></i>
		        
		        <button class="avatar-camera-btn" onclick="changeAvatar()">
		            <i class="fa-solid fa-camera"></i>
		        </button>
		    </div>

		    <!-- 자녀 정보 -->
		    <div class="child-info" id="viewMode">
		        <h4 id="childName">
		            <span th:text="${child.name}"></span>
		        </h4>
		        <p>
		            <span id="childBirthday" th:text="${child.birth_date}"></span> 
		            (<span th:text="${child.gender}" id="childGender"></span>)<br>
		            태어난지 <span th:text="${child.ageInMonths}"></span>개월 됐어요.
		        </p>
		        <input type="hidden" id="childId" th:value="${child.child_id}">
		    </div>
			
			<button class="child-edit-btn" id="editBtn" onclick="toggleEditMode()">수정</button>
		</div>

        <!-- 접종 수첩 -->
        <div class="mypage-card">
            <h4>접종 수첩</h4>

            <table class="vaccine-table">
                <thead>
                    <tr>
                        <th>대상전염병</th>
                        <th>1차</th>
                        <th>2차</th>
                        <th>3차</th>
                        <th>4차</th>
                        <th>5차</th>
                        <th>6차</th>
                    </tr>
                </thead>
            <tbody>
                <tr th:each="vaccine : ${vaccines}">
                    <!-- 대상전염병 -->
                    <td th:text="${vaccine.vaccine_name}"></td>
            
                    <!-- 1차 ~ 6차 고정 -->
                    <td th:each="dose, stat : ${doses}"
                        th:if="${stat.index < 6}"
                        th:with="key=${vaccine.vaccine_id + '_' + dose.dose_id},
                                 record=${vaccineRecords.get(key)}"
                        th:classappend="${record != null ? 'vaccine-empty saved' : 'vaccine-empty'}"
                        th:data-vaccine-id="${vaccine.vaccine_id}"
                        th:data-dose-id="${dose.dose_id}">
            
                        <!-- 저장된 데이터가 있으면 표시 -->
                        <div th:if="${record != null}" class="vaccine-saved-data">
                            <div class="saved-hospital" th:text="${record.hospital}">병원명</div>
                            <div class="saved-date" th:text="${record.vaccinated_date}">날짜</div>
                            <div class="saved-vaccine" th:text="${record.vaccine_product}">백신명</div>
                        </div>
                        <button th:if="${record != null}" 
                                class="vaccine-edit-btn" 
                                onclick="editVaccineData(this)">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                     <button th:if="${record != null}" 
                                class="vaccine-delete-btn" 
                           th:data-child-vaccine-id="${record.child_vaccine_id}"
                                onclick="deleteVaccineData(this)">
                            <i class="fa-solid fa-trash"></i>
                        </button>
            
                        <!-- 저장된 데이터가 없으면 입력창 표시 -->
                        <span th:if="${record == null}" 
                              class="vaccine-placeholder"
                              onclick="openVaccineInput(this)">클릭해서 입력</span>
            
                        <div class="vaccine-input-box">
                            <input type="text" placeholder="접종한 병원">
                            <input type="date">
                            <input type="text" placeholder="백신 제품명">
                        </div>
                    </td>
                </tr>
            </tbody>
            </table>
        </div>

    </section>
</div>

<!-- footer -->
<div th:replace="~{fragments/footer::footer}"></div>
<!-- 모달 스크립트 -->
<div th:replace="~{fragments/header::modalScript}"></div>

<script>
   
   // 페이지 로드 시 한 번만 실행
   $(document).ready(function() {
       const token = $("meta[name='_csrf']").attr("content");
       const header = $("meta[name='_csrf_header']").attr("content");
       
       // 모든 Ajax 요청에 자동으로 CSRF 토큰 추가
       $(document).ajaxSend(function(e, xhr, options) {
           xhr.setRequestHeader(header, token);
       });
   });
   
   let activeVaccineTd = null; //현재 열려있는 접종 칸

   // 백신 입력
   function openVaccineInput(element) {
      
      const td = element.closest('td');
         
      if (!td) {
             console.error('td를 찾을 수 없습니다');
             return;
      }
      
       // 이미 다른 칸이 열려 있으면 무시
       if (activeVaccineTd && activeVaccineTd !== td) {
           return;
       }

       // 이미 활성화된 경우도 무시
       if (td.classList.contains('active')) return;

       activeVaccineTd = td;
       td.classList.add('active');

       const inputBox = td.querySelector('.vaccine-input-box');

      if (!inputBox.querySelector('.vaccine-cancel-btn')) {
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'vaccine-cancel-btn';
          cancelBtn.textContent = '취소';
          cancelBtn.onclick = function(e) {
            e.stopPropagation();
            td.classList.remove('active');
            activeVaccineTd = null;
          };
          inputBox.appendChild(cancelBtn);
      }
      
       if (!inputBox.querySelector('.vaccine-save-btn')) {
           const saveBtn = document.createElement('button');
           saveBtn.className = 'vaccine-save-btn';
           saveBtn.textContent = '저장';
           saveBtn.onclick = function(e) {
               e.stopPropagation();
               saveVaccineData(td);
           };
           inputBox.appendChild(saveBtn);
       }
      

   }
   
   //백신 데이터 저장
   function saveVaccineData(td) {
       const inputBox = td.querySelector('.vaccine-input-box');
       const hospital = inputBox.querySelector('input[type="text"]:nth-child(1)').value.trim();
       const date = inputBox.querySelector('input[type="date"]').value;
       const vaccine = inputBox.querySelector('input[type="text"]:nth-child(3)').value.trim();
      const childId = document.getElementById('childId').value;
      const vaccineId = td.dataset.vaccineId;  
      const doseId = td.dataset.doseId;

       if (!hospital || !date || !vaccine) {
           alert("모든 항목을 입력해주세요.");
           return;
       }

       $.ajax({
           url: '/myPage/saveVaccine',
           type: 'POST',
           contentType: 'application/json',
           data: JSON.stringify({
            child_id: childId,
              vaccine_id: vaccineId,
              dose_id: doseId,
              vaccinated_date: date,
              hospital: hospital,
              vaccine_product: vaccine
           }),
           success: function (res) {
            
            const childVaccineId = res.childVaccineId;

               // DB 저장 성공 시 화면 반영
               td.classList.remove('active');
               td.classList.add('saved');
               td.innerHTML = `
                   <div class="vaccine-saved-data">
                       <div class="saved-hospital">${hospital}</div>
                       <div class="saved-date">${date}</div>
                       <div class="saved-vaccine">${vaccine}</div>
                   </div>
               <button class="vaccine-edit-btn"
                        data-child-vaccine-id="${childVaccineId}"
                        onclick="editVaccineData(this)">
                    <i class="fa-solid fa-pen"></i>
                </button>

                <button class="vaccine-delete-btn"
                        data-child-vaccine-id="${childVaccineId}"
                        onclick="deleteVaccineData(this)">
                    <i class="fa-solid fa-trash"></i>
                </button>
               `;

               activeVaccineTd = null;
           },
           error: function () {
               alert("저장 중 오류가 발생했습니다.");
           }
       });
   }

   // 백신 데이터 수정
   function editVaccineData(btn) {
       const td = btn.closest('td');

       // 다른 칸 수정 중이면 무시
       if (activeVaccineTd && activeVaccineTd !== td) {
           return;
       }

       activeVaccineTd = td;

       const savedData = td.querySelector('.vaccine-saved-data');
       const hospital = savedData.querySelector('.saved-hospital').textContent;
       const date = savedData.querySelector('.saved-date').textContent;
       const vaccine = savedData.querySelector('.saved-vaccine').textContent;

       td.classList.remove('saved');
       td.classList.add('active');
       td.innerHTML = `
           <span class="vaccine-placeholder">클릭해서 입력</span>
           <div class="vaccine-input-box" style="display: block;">
               <input type="text" value="${hospital}">
               <input type="date" value="${date}">
               <input type="text" value="${vaccine}">
            <div class="vaccine-buttons">
            <button class="vaccine-cancel-btn" onclick="saveVaccineData(this.closest('td'))">취소</button>
               <button class="vaccine-save-btn" onclick="saveVaccineData(this.closest('td'))">저장</button>
            </div>
           </div>
       `;
   }
   
   // 백신 데이터 삭제
   function deleteVaccineData(btn) {
       const childVaccineId = btn.dataset.childVaccineId;
      
      if(!confirm("해당 내용을 삭제하시겠습니까?")){
         return;
      }
      
      $.ajax({
          url: '/myPage/deleteVaccine',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            child_vaccine_id : childVaccineId
          }),
          success: function (res) {
            const td = btn.closest('td');
            
               td.classList.remove('saved');
               td.innerHTML = `
                   <span class="vaccine-placeholder"
                         onclick="openVaccineInput(this)">클릭해서 입력</span>
                   <div class="vaccine-input-box">
                       <input type="text" placeholder="접종한 병원">
                       <input type="date">
                       <input type="text" placeholder="백신 제품명">
                   </div>
               `;
          },
          error: function () {
              alert("삭제 중 오류가 발생했습니다.");
          }
      });
   }


   // 편집 모드 토글 (카메라만 보이게)
   function toggleEditMode() {
       const editBtn = document.getElementById('editBtn');
       const childCard = document.getElementById('childCard');
       const cameraBtn = document.querySelector('.avatar-camera-btn');
       
       if (childCard.classList.contains('editing')) {
           // 편집 모드 종료
           childCard.classList.remove('editing');
           editBtn.textContent = '수정';
       } else {
           // 편집 모드 시작
           childCard.classList.add('editing');
           editBtn.textContent = '완료';
       }
   }

   // 자녀 사진 저장
   function changeAvatar(){
       // 파일 선택 input 생성
       const input = document.createElement('input');
       input.type = 'file';
       input.accept = 'image/*';
       
       input.onchange = function(e){
           const file = e.target.files[0];
           if(!file) return;
           
           // 파일 크기 제한
           if(file.size > 5 * 1024 * 1024) {
               alert('파일 크기는 5MB 이하여야 합니다.');
               return;
           }
           
           // 이미지 파일인지 확인 
           if(!file.type.startsWith('image/')){
               alert('이미지 파일만 업로드 가능합니다.');
               return;
           }
           
           // FormData 생성
           const formData = new FormData();
           formData.append('profileImage', file);
           formData.append('childId', document.getElementById('childId').value);
           
           $.ajax({
               url: '/myPage/uploadProfileImage',
               type: 'POST',
               data: formData,
               processData: false,
               contentType: false,  
               success: function(response){
                   // 성공시 이미지 미리보기
                   const reader = new FileReader(); 
                   reader.onload = function(e) {
                       const avatar = document.querySelector('.child-avatar');
                       // 아이콘 대신 이미지로 변경
                       avatar.innerHTML = `
                           <img src="${e.target.result}" alt="프로필 사진" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                           <button class="avatar-camera-btn" onclick="changeAvatar()">
                               <i class="fa-solid fa-camera"></i>
                           </button>
                       `;
                       
                       // 편집 모드 종료
                       const childCard = document.getElementById('childCard');
                       const editBtn = document.getElementById('editBtn');
                       childCard.classList.remove('editing');
                       editBtn.textContent = '수정';
                       
                       alert('프로필 사진이 변경되었습니다.');
                   };
                   reader.readAsDataURL(file);
               },
               error: function() {
                   alert('사진 업로드 중 오류가 발생했습니다.');
               }
           });
       };
       input.click();
   }


</script>

</body>
</html>